# CANVAS
**CANVAS: CANOPUS and SIRIUS Visualization & Analysis System**

---

## Overview
CANVAS is an interactive Dash application for **visualization and interpretation of LC-MS metabolomics data**.  
It integrates aligned peak intensity data (e.g., from [MSDIAL](https://systemsomicslab.github.io/compms/msdial/main.html)) with results from the [SIRIUS](https://bio.informatik.uni-jena.de/software/sirius/) workflow, including compound classification output from **CANOPUS**.  

The tool enables researchers to:
- Integrate SIRIUS and CANOPUS outputs with intensity-based measurements.
- Explore metabolite classes dynamically using thresholds and ontology levels.
- Visualize results with **sunburst plots, bar charts, PCA, and random forest classifier**.
- Compare metabolite distributions across samples or conditions.
- Streamline hypothesis generation in untargeted metabolomics workflows.

---

## Features
- üìä **Interactive visualizations** (sunburst, bar charts, PCA, random forest).  
- üß≠ **Dynamic filtering** by class confidence, SIRIUS annotation scores, hierarchy levels, and intensity levels.  
- üîç **Exploration of SIRIUS & CANOPUS outputs** with user-friendly controls.  
- üß™ **Example datasets** provided (plant metabolomics, lipidomics, human cell metabolomics).  

---

## Installation

### 1. Clone the repository
```bash
git clone https://github.com/your-username/CANVAS.git
cd CANVAS
```

### 2. Install dependencies
```bash
pip install -r requirements.txt
```

### 3. Run CANVAS
```bash
python app.py
```

This should automatically open a browser window at [http://127.0.0.1:8050](http://127.0.0.1:8050).

---

## Data Input Processing

CANVAS uses **four input files**:

1. **Integrated intensity features** (`.csv`)  
   - Typically exported from MSDIAL.  
   - Other LC‚ÄìMS/MS extraction tools may work if formatted correctly.

2. **SIRIUS output (structure file)** (`structure_identification.tsv`)  
   - Exported from the ‚ÄúSummaries‚Äù tab in SIRIUS (top 1 hit recommended).

3. **CANOPUS output (class annotations)** (`canopus_structure_identification.tsv`)  
   - Exported from SIRIUS after classification.

4. **Metadata file** (`.csv`)  
   - User-generated, containing sample annotations and experimental variables.

### 1. Integrated area peak file
The easiest way to start is with integrated features extracted in MSDIAL.  
Tutorials can be found on the [MSDIAL website](https://systemsomicslab.github.io/mtbinfo.github.io/MS-DIAL/tutorial.html#chapter-2).  

Export both the aligned area peaks and the `.mat` MS/MS spectra file for further SIRIUS processing. Example export settings:  

<img width="1279" height="908" alt="MSDIAL export" src="https://github.com/user-attachments/assets/6e3a0898-aa6a-40ea-b41a-daf9dd0b7ee6" />

---

### 2. SIRIUS structure & CANOPUS output files
Run SIRIUS with the `.mat` file generated by MSDIAL.  
Export the following from the ‚ÄúSummaries‚Äù panel (TSV format):  
- `structure_identification.tsv`  
- `canopus_structure_identification.tsv`  

<img width="1328" height="778" alt="SIRIUS export" src="https://github.com/user-attachments/assets/cb142b14-3428-4ee2-9b73-9489e68c5f2f" />

---

### 3. Metadata
The metadata `.csv` file must follow these rules:  
- First row = column names.  
- First column **must be named** `name_file` (sample names).  
- Sample names must match those from MSDIAL output.  
- Additional columns = experimental variables.  
- Blank samples must contain the keyword `"Blank"` for automatic blank subtraction.  

<img width="588" height="348" alt="metadata" src="https://github.com/user-attachments/assets/09673fe1-95fe-4379-94bf-29c8119d8228" />

---

## Starting CANVAS

### 1. Loading the data
After starting CANVAS, upload the four input files in the header section.  
- For first-time analysis: select **‚ÄúFiles are raw‚Äù**.  
- For reloading saved data: select **‚ÄúLoad Files‚Äù**.  

Large datasets (>50 MB) may take several seconds to minutes to load.  

<img width="2298" height="606" alt="load files" src="https://github.com/user-attachments/assets/b17f212e-fba4-4340-83d5-73ffc39cbf52" />

---

### 2. Processing the data
Steps include:  

1. **Blank removal** ‚Äì average blank samples, remove features below user-defined ratio (e.g., 0.1).  
2. **Imputation** ‚Äì replace missing/zero values with small sampled values.  
3. **Normalization** ‚Äì by TIC (Total Ion Chromatogram).  
4. **Scaling** ‚Äì `StandardScaler()` (mean-centered, unit variance).  

<img width="2521" height="608" alt="processing" src="https://github.com/user-attachments/assets/c3aa179c-0c24-4baa-a658-38ce8f8c2d8a" />

---

## Visualization & Data Analysis

### GUI overview
The GUI provides panels for:  
- **Filters**  
- **Display options**  
- **Selection options**  
- **Feature browsing**  

### Filters
Three sliders allow filtering by:  
- Intensity threshold  
- SIRIUS score threshold  
- CANOPUS score threshold  

### Visualizations
- **Sunburst plot**  
- **Bar chart**  
- **Boxplots**  

### Multivariate Analysis
- **PCA** ‚Äì overview of sample variance, feature contributions.  
- **Random Forest** ‚Äì supervised feature importance analysis.  

---

## Exporting Data
Use the **‚ÄúExport data‚Äù** button to save the processed dataset.  
- With **‚ÄúFiltered‚Äù** checked ‚Üí exports only filtered data.  
- Without ‚Üí exports full processed dataset.  

---

## Citation
If you use CANVAS in your research, please cite:  

> Lehr, F.-X., Paczia, N. **CANVAS: An Interactive Dash Application for Visualization and Analysis of LC-MS Metabolomics Data using the SIRIUS Workflow**. *Year*.  

---

## License
Distributed under the MIT License. See [LICENSE](LICENSE) for details.  
